<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
 "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="WORK">
	<!-- 为类型定义别名 -->
	<typeAlias alias="work" type="cn.seu.cose.entity.Work" />
	<!-- 定义resultMap,将query结果映射为bean -->
	<resultMap id="WorkResultMap" class="work">
		<result property="id" column="ID"/>
		<result property="workName" column="WORK_NAME"/>
		<result property="userId" column="USER_ID"/>
		<result property="workPics" column="WORK_PICS"/>
		<result property="activityId" column="ACTIVITY_ID"/>
		<result property="intro" column="INTRO"/>
		<result property="voteCount" column="VOTE_COUNT"/>
		<result property="updateTime" column="UPDATE_TIME"/>
	</resultMap>

	<select id="selectWorkById" resultMap="WorkResultMap" parameterClass="int">
		<![CDATA[
    		SELECT * 
    		FROM WORK
    		WHERE id=#value#
		]]>
	</select>
	
	<select id="selectWorksByUserId" resultMap="WorkResultMap" parameterClass="int">
		<![CDATA[
    		SELECT * 
    		FROM WORK
    		WHERE user_id=#value#
		]]>
	</select>
	
	<select id="selectWorksByUserIdAndBaseAndRange" resultMap="WorkResultMap" parameterClass="java.util.Map">
		<![CDATA[
		SELECT * FROM
			(SELECT * 
			FROM WORK
			WHERE user_id = #userId#
			ORDER BY update_time DESC) a
		LIMIT #base#,#range#
		]]>
	</select>
	
	<select id="selectRecentWorksByActivityId" resultMap="WorkResultMap" parameterClass="int">
		<![CDATA[
			SELECT * FROM
        		(SELECT * 
        		FROM WORK
        		WHERE activity_id=#value#
				ORDER BY vote_count DESC) a
			LIMIT 3
		]]>
	</select>
	
	<select id="selectHotWorks" resultMap="WorkResultMap">
		<![CDATA[
		SELECT * FROM
			(SELECT * 
			FROM WORK
			WHERE activity_id > 0
			ORDER BY vote_count DESC) a
		LIMIT 4
		]]>
	</select>
	
	<select id="selectWorksByActivityIdAndBaseAndRange" resultMap="WorkResultMap" parameterClass="java.util.Map">
		<![CDATA[
		SELECT * FROM
			(SELECT * 
			FROM WORK
			WHERE activity_id = #activityId#
			ORDER BY update_time DESC) a
		LIMIT #base#,#range#
		]]>
	</select>
		
	<select id="selectWorksCountByActivityId" resultClass="int" parameterClass="int">
		<![CDATA[
			SELECT count(id) 
			FROM WORK
			WHERE activity_id = #value#
		]]>
	</select>
		
	<select id="selectWorksCountByDesignerId" resultClass="int" parameterClass="int">
		<![CDATA[
			SELECT count(id) 
			FROM WORK
			WHERE user_id = #value#
		]]>
	</select>
	
	<insert id="insertWork" parameterClass="work">
		<![CDATA[
    		INSERT INTO WORK
    		(work_name,user_id,work_pics,activity_id,intro,vote_count,update_time)
    		VALUES (#workName#,#userId#,#workPics#,#activityId#,#intro#,#voteCount#,current_timestamp())
    	]]>
	</insert>

	<update id="updateWork" parameterClass="work">
		<![CDATA[
		UPDATE WORK
		SET	work_name = #workName#,
			work_pics= #workPics#,
			activity_id = #activityId#,
			intro = #intro#,
			update_time = current_timestamp()
		WHERE id = #id#
		]]>
	</update>
	
	<update id="updateVote" parameterClass="int">
		<![CDATA[
		UPDATE WORK
		SET	vote_count = vote_count + 1
		WHERE id = #value#
		]]>
	</update>
	
	<delete id="deleteWork" parameterClass="int">
		<![CDATA[
		DELETE FROM WORK WHERE id = #value#
		]]>
	</delete>
	
</sqlMap>